{{#section 'style'}}
  <style>
    .it_content {
      position: relative;
    }
    .delete {
      float: right;
      /*line-height: 53px;*/
    }
    .it_content:first-child .delete,
    .lists-content [data-name="lists"]:first-child [data-name="delete"] {
      display: none;
    }
    [data-name="add"] {
      margin: 0 10px;
    }
    #error-msg {
      margin: 10px 0;
      display: none;
    }
    #test_account:checked + #account-content {
      display: block !important;
    }
    .btn-toolbar+.btn-toolbar {
      margin-top: 10px;
    }
  </style>
{{/section}}

<div class="starter-template">
  <div class="page-header">
    <h1>Create task page</h1>    
  </div>

  <div id="hide" class="hide">
    {{> action}}
    {{> check}}
  </div>

  <form action="/create_task" method="POST" id="task_form">
    <h2>Basic info</h2>
    <hr/>
    <div id="basic_info">
      {{!-- describe main task --}}
      <div class="form-group">
        <label for="describe">describe main task:</label>
        <input id="describe" type="text" name="describe" class="form-control" />
      </div>
  
      {{!-- the url --}}
      <div class="form-group">
        <label for="url">The url:</label>
        <input id="url" type="text" name="url" class="form-control" />
      </div>
  
      {{!-- The language --}}
      <p>
        <label for="lang">
          The language:
          {{> langs}}
        </label>
      </p>
  
      {{!-- Test account and password --}}
      <label>
        Do you use test account?
        <input type="checkbox" id="test_account" name="test_account" />

        <div id="account-content" class="form-inline hide">
           <label>
             User name
             <input type="text" name="user"/>
           </label>
           <label>
             Password
             <input type="password" name="password" />
           </label>
        </div>
      </label>
    </div>{{!-- basic_info end --}}
  
    <hr/>
    <h2>Create Steps</h2>
    <hr/>
  
    <div id="create_step">
      {{!-- Basic step --}}
      {{> basic_step}}
    </div>
  
    <div class="btn-toolbar"><button type="button" id="add" class="btn btn-primary">Add Steps</button></div>
    <div class="btn-toolbar"><button id="btn" type="submit" class="btn btn-default">Create task</button>
    </div>
  </form>
  <div class="alert alert-danger" role="alert" id="error-msg"></div>
</div>

{{#section 'jquery'}}
<script>
  $(function () {
    var tasks = tasks || {},
        $task_form = $('#task_form'),
        $hide = $('#hide'),
        $msg = $('#error-msg'),
        $obj = {
          btn:       $task_form.find('#btn'),
          describe:  $task_form.find('#describe'),
          url:       $task_form.find('#url'),
          lang:      $task_form.find('#lang'),
          add:       $task_form.find('#add'),
          account:   $task_form.find('#test_account'),
          steps:     $task_form.find('#create_step')
        },
        lock_ajax = false,
        cache_step = $obj.steps.html(),
        cache_action = $hide.find('.action').html(),
        cache_check = $hide.find('.check').html(),
        cache_list = $obj.steps.find('.lists-content').html(),
    disableBtn = function (data) {
      if (data.success) {
        $obj.btn.text('Created');
        $msg.text(data.message);
      } else {
        $msg.text(data.message).fadeIn(1500, function () {
          $obj.btn.prop('disabled', true);
        }).delay(3000).fadeOut(1500, function () {
          $obj.btn.prop('disabled', false);
          lock_ajax = false;
        });
      }
    },
    createTask = function () {
      // disabled the btn
      $obj.btn.prop('disabled', true);

      // lock the ajax function
      if (lock_ajax) { return; }
      lock_ajax = true;

      // setup the config object
      renderData();

      // send ajax
      $.ajax({
        type: 'post',
        url: '/create_task.api',
        dataType: 'json',
        data: tasks.config,
        success: disableBtn
      });
    },
    addSteps = function () {
      $obj.steps.append(cache_step);
    },
    deleteStep = function () {
      $(this).parents('.it_content').remove();
    },
    typeOnChange = function () {
      var $this = $(this),
          val = $this.val(),
          $type_content = $this.parent('label').next('.type_content');

      if (val === 'action') {
        $type_content.html(cache_action);
      } else {
        $type_content.html(cache_check);
      }
    },
    addOrDeleteList = function (e) {
      e.preventDefault();
      var $this = $(this),
          $content = $this.parents('.lists-content'),
          $lists = $this.parents('[data-name="lists"]'),
          data_action = $this.data('name');

      if (data_action === 'add') {
        $content.append(cache_list);
      } else {
        $lists.remove();
      }
    },
    sendKeys = function () {
      var $this = $(this),
          $sendKeys = $this.next('[data-name="sendKeys"]'),
          action_val = $this.val();
      if (action_val === 'sendKeys') {
        $sendKeys.show();
      } else {
        $sendKeys.hide().val('');
      }
    },
    accountOnChange = function () {
      // reset account value
      if (!$(this).prop("checked")) {
        $('#account-content').find('input').each(function (idx, tar) {
          $(tar).val('');
        });
      }
    },
    renderData = function () {
      // $task_form.find('[name]').each(function (idx, tar) {
      $('#basic_info').find('[name]').each(function (idx) {
        var $this = $(this),
            it_contain = $this.parents('.it_content').length,
            cur_name = $this.attr('name'),
            value = (cur_name === 'test_account') ? ($this.prop('checked')) : ($this.val());
        
        if (!it_contain) {
          tasks.config[cur_name] = value;
        }

      });

      $('.it_content').each(function (outer_idx) {
        var $current = $(this).find('[name="it_name"]'),
            it_name = $current.attr('name'),
            it_des = $current.val(),
            arr = []; // "arr" array reset
        
        tasks.config.it[outer_idx] = {};
        tasks.config.it[outer_idx][it_name] = it_des;

        $(this).find('[data-name="lists"]').each(function (index) {
          var out_idx = index;
          arr[out_idx] = {};
          $(this).find('[name]').each(function (idx, target) {
            var name = $(this).attr('name');
            arr[out_idx][name] = $(target).val();
          });
        });
        // the "events" array object
        tasks.config.it[outer_idx]["events"] = arr;
      });
      console.log(tasks.config);
    };

    // Main object
    tasks.config = {};
    tasks.config.it = [];

    // Click event
    $obj.btn.on('click', createTask);
    $obj.add.on('click', addSteps);
    $obj.steps.on('click', '.delete', deleteStep);
    $obj.steps.on('click', '.type_content [data-name="add"], .type_content [data-name="delete"]', addOrDeleteList);

    // Change event
    $obj.account.on('change', accountOnChange);
    $obj.steps.on('change', '[name="type"]', typeOnChange);
    $obj.steps.on('change', '[name="action"]', sendKeys);
  });
</script>
{{/section}}